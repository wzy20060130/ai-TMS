<script setup lang="ts">
import { ref, reactive } from 'vue';
import { Search, Refresh, Download } from '@element-plus/icons-vue';
import { ElMessage } from 'element-plus';

// ÁªüËÆ°Êï∞ÊçÆ
const stats = ref([
  {
    label: 'ËøêË°å‰∏≠Êï∞Èáè',
    value: 86,
    change: 'ËæÉÊò®Êó• ‚Üë 2.3%',
    icon: 'üìã',
    color: '#E3F2FD',
  },
  {
    label: 'ÂæÖÂ§ÑÁêÜÂºÇÂ∏∏',
    value: 42,
    change: 'ËæÉÊò®Êó• ‚Üë 1.7%',
    icon: '‚ö†Ô∏è',
    color: '#F3E5F5',
  },
  {
    label: 'Â∑≤Â§ÑÁêÜÂºÇÂ∏∏',
    value: 44,
    change: 'ËæÉÊò®Êó• ‚Üë 3.8%',
    icon: '‚úÖ',
    color: '#FFF3E0',
  },
  {
    label: 'Â∑≤ÂÖ≥Èó≠ÂºÇÂ∏∏',
    value: 16,
    change: 'ËæÉÊò®Êó• ‚Üë 1.6%',
    icon: 'üîí',
    color: '#E8F5E9',
  },
]);

// Á≠õÈÄâÊù°‰ª∂
const filters = reactive({
  exceptionStatus: '',
  exceptionType: '',
  urgencyLevel: '',
  processingStatus: '',
  handler: '',
  dateRange: [],
  keyword: '',
});

// ÂºÇÂ∏∏Áä∂ÊÄÅÈÄâÈ°π
const exceptionStatusOptions = [
  { label: 'ÂÖ®ÈÉ®', value: '' },
  { label: 'ÂæÖÂ§ÑÁêÜ', value: '1' },
  { label: 'Â§ÑÁêÜ‰∏≠', value: '2' },
  { label: 'Â∑≤Â§ÑÁêÜ', value: '3' },
  { label: 'Â∑≤ÂÖ≥Èó≠', value: '4' },
];

// ÂºÇÂ∏∏Á±ªÂûãÈÄâÈ°π
const exceptionTypeOptions = [
  { label: 'ÂÖ®ÈÉ®', value: '' },
  { label: 'ËøêËæìÂª∂ËØØ', value: '1' },
  { label: 'Ë¥ßÁâ©ÊçüÂùè', value: '2' },
  { label: 'Ë¥ßÁâ©‰∏¢Â§±', value: '3' },
  { label: 'ÊãíÊî∂', value: '4' },
  { label: 'ÂÖ∂‰ªñ', value: '5' },
];

// Á¥ßÊÄ•Á®ãÂ∫¶ÈÄâÈ°π
const urgencyLevelOptions = [
  { label: 'ÂÖ®ÈÉ®', value: '' },
  { label: 'Á¥ßÊÄ•', value: '1' },
  { label: 'ÈáçË¶Å', value: '2' },
  { label: '‰∏ÄËà¨', value: '3' },
];

// Â§ÑÁêÜÁä∂ÊÄÅÈÄâÈ°π
const processingStatusOptions = [
  { label: 'ÂÖ®ÈÉ®', value: '' },
  { label: 'ÂæÖÂ§ÑÁêÜ', value: '1' },
  { label: 'Â§ÑÁêÜ‰∏≠', value: '2' },
  { label: 'Â∑≤Ëß£ÂÜ≥', value: '3' },
];

// ÂºÇÂ∏∏ËÆ¢ÂçïÂàóË°®
const exceptionList = ref([
  {
    id: 'ABN-2023061001',
    orderNo: 'ORD-2023061001',
    waybillNo: 'WB-2023061001',
    pickupNo: 'PK-2023061001',
    exceptionType: 'ËøêËæìÂª∂ËØØ',
    exceptionTypeTag: 'danger',
    status: 'ÂæÖÂ§ÑÁêÜ',
    statusType: 'warning',
    urgency: 'Á¥ßÊÄ•',
    urgencyType: 'danger',
    reportTime: '2023-06-16 10:30',
    reporter: 'Âº†‰∏â',
    handler: 'Êú™ÂàÜÈÖç',
    processingTime: '-',
    description: 'ÂÆ¢Êà∑ÂèçÈ¶àË¥ßÁâ©Êú™ÊåâÊó∂ÈÄÅËææÔºåÂª∂ËØØ2Â∞èÊó∂ÔºåÂÆ¢Êà∑Ë¶ÅÊ±ÇÂ∞ΩÂø´ÈÄÅËææÔºåÂê¶ÂàôÂ∞ÜÂèñÊ∂àËÆ¢Âçï',
    solution: '-',
  },
  {
    id: 'ABN-2023061002',
    orderNo: 'ORD-2023061003',
    waybillNo: 'WB-2023061003',
    pickupNo: 'PK-2023061002',
    exceptionType: 'Ë¥ßÁâ©ÊçüÂùè',
    exceptionTypeTag: 'danger',
    status: 'Â∑≤Â§ÑÁêÜ',
    statusType: 'success',
    urgency: 'ÈáçË¶Å',
    urgencyType: 'warning',
    reportTime: '2023-06-16 14:15',
    reporter: 'ÊùéÂõõ',
    handler: 'Áéã‰∫î',
    processingTime: '2023-06-16 15:30',
    description: 'Êî∂Ë¥ßÊñπÂèçÈ¶àË¥ßÁâ©ÂåÖË£ÖÁ†¥ÊçüÔºåÈÉ®ÂàÜË¥ßÁâ©ÂèóÊçüÔºåÈúÄË¶ÅÈáçÊñ∞ÈÖçÈÄÅÊàñËµîÂÅø',
    solution: '‰∏éÂÆ¢Êà∑ÂçèÂïÜÂêéÔºåÈáçÊñ∞ÈÖçÈÄÅÂÆåÂ•ΩË¥ßÁâ©ÔºåÊçüÂùèË¥ßÁâ©Êåâ‰ª∑ÂÄºËµîÂÅø30%',
  },
  {
    id: 'ABN-2023061003',
    orderNo: 'ORD-2023061002',
    waybillNo: 'WB-2023061002',
    pickupNo: 'PK-2023061003',
    exceptionType: 'ÂºÇÂ∏∏ÊãíÊî∂',
    exceptionTypeTag: 'warning',
    status: 'Â§ÑÁêÜ‰∏≠',
    statusType: 'primary',
    urgency: '‰∏ÄËà¨',
    urgencyType: 'info',
    reportTime: '2023-06-16 16:20',
    reporter: 'ËµµÂÖ≠',
    handler: 'Â≠ô‰∏É',
    processingTime: '2023-06-16 16:45',
    description: 'Êî∂Ë¥ßÊñπÊãíÊî∂Ë¥ßÁâ©ÔºåÁêÜÁî±ÊòØËÆ¢ÂçïÊúâËØØÔºåÈúÄË¶ÅÊ†∏ÂÆûËÆ¢Âçï‰ø°ÊÅØÂπ∂ÈáçÊñ∞ÈÖçÈÄÅ',
    solution: 'Ê≠£Âú®‰∏éÂÆ¢Êà∑Ê≤üÈÄöÁ°ÆËÆ§ËÆ¢Âçï‰ø°ÊÅØ',
  },
  {
    id: 'ABN-2023061004',
    orderNo: 'ORD-2023061005',
    waybillNo: 'WB-2023061005',
    pickupNo: 'PK-2023061004',
    exceptionType: 'ËΩ¶ËæÜÊïÖÈöú',
    exceptionTypeTag: 'danger',
    status: 'Â∑≤Â§ÑÁêÜ',
    statusType: 'success',
    urgency: 'Á¥ßÊÄ•',
    urgencyType: 'danger',
    reportTime: '2023-06-16 09:15',
    reporter: 'Âë®ÂÖ´',
    handler: 'Âê¥‰πù',
    processingTime: '2023-06-16 10:30',
    description: 'ËøêËæìËΩ¶ËæÜÂú®ÈÄî‰∏≠ÂèëÁîüÊïÖÈöúÔºåÊó†Ê≥ïÁªßÁª≠ËøêËæìÔºåÈúÄË¶ÅË∞ÉÈÖçÂÖ∂‰ªñËΩ¶ËæÜÊé•ÊõøËøêËæì',
    solution: 'Â∑≤Ë∞ÉÈÖçÂ§áÁî®ËΩ¶ËæÜÊé•ÊõøËøêËæìÔºåË¥ßÁâ©Â∑≤ÊåâÊó∂ÈÄÅËææ',
  },
  {
    id: 'ABN-2023061005',
    orderNo: 'ORD-2023061008',
    waybillNo: 'WB-2023061008',
    pickupNo: 'PK-2023061005',
    exceptionType: 'ËÆ¢ÂçïÂèñÊ∂à',
    exceptionTypeTag: 'info',
    status: 'ÂæÖÂ§ÑÁêÜ',
    statusType: 'warning',
    urgency: '‰∏ÄËà¨',
    urgencyType: 'info',
    reportTime: '2023-06-17 11:00',
    reporter: 'ÈÉëÂçÅ',
    handler: 'Êú™ÂàÜÈÖç',
    processingTime: '-',
    description: 'ÂÆ¢Êà∑‰∏¥Êó∂ÂèñÊ∂àËÆ¢ÂçïÔºåË¥ßÁâ©Â∑≤Ë£ÖËΩ¶ÂáÜÂ§áÂèëËøêÔºåÈúÄË¶ÅÂçèÂïÜÂèñÊ∂àË¥πÁî®ÂèäË¥ßÁâ©ÈÄÄÂõû‰∫ãÂÆú',
    solution: '-',
  },
]);

// ÂàÜÈ°µ
const pagination = ref({
  currentPage: 1,
  pageSize: 20,
  total: 1248,
});

// ÊêúÁ¥¢
const handleSearch = () => {
  // TODO: ÂÆûÁé∞ÊêúÁ¥¢ÈÄªËæë
  ElMessage.success('ÊêúÁ¥¢ÂÆåÊàê');
};

// ÈáçÁΩÆ
const handleReset = () => {
  Object.assign(filters, {
    exceptionStatus: '',
    exceptionType: '',
    urgencyLevel: '',
    processingStatus: '',
    handler: '',
    dateRange: [],
    keyword: '',
  });
};

// ÂØºÂá∫
const handleExport = () => {
  ElMessage.success('Ê≠£Âú®ÂØºÂá∫Êï∞ÊçÆ...');
};

// ÊâπÈáèÂ§ÑÁêÜ
const handleBatchProcess = () => {
  ElMessage.info('ÊâπÈáèÂ§ÑÁêÜÂºÇÂ∏∏');
};

// Êü•ÁúãËØ¶ÊÉÖ
interface ExceptionRow {
  id: number;
  [key: string]: unknown;
}
const handleView = (_row: ExceptionRow) => {
  // TODO: ÂÆûÁé∞Êü•ÁúãËØ¶ÊÉÖÈÄªËæë
};

// Â§ÑÁêÜÂºÇÂ∏∏
const handleProcess = (_row: ExceptionRow) => {
  // TODO: ÂÆûÁé∞Â§ÑÁêÜÂºÇÂ∏∏ÈÄªËæë
  ElMessage.success('Â∑≤ÂàÜÈÖçÂ§ÑÁêÜ‰∫∫Âëò');
};

// ÂàÜÈ°µÊîπÂèò
const handlePageChange = (page: number) => {
  pagination.value.currentPage = page;
};

const handleSizeChange = (size: number) => {
  pagination.value.pageSize = size;
};
</script>

<template>
  <div class="exception-container">
    <!-- È°∂ÈÉ®ÁªüËÆ°Âç°Áâá -->
    <div class="stats-grid">
      <div
        v-for="(stat, index) in stats"
        :key="index"
        class="stat-card"
        :style="{ backgroundColor: stat.color }"
      >
        <div class="stat-icon">{{ stat.icon }}</div>
        <div class="stat-content">
          <div class="stat-label">{{ stat.label }}</div>
          <div class="stat-value">{{ stat.value }}</div>
          <div class="stat-change">{{ stat.change }}</div>
        </div>
      </div>
    </div>

    <!-- Á≠õÈÄâÂå∫Âüü -->
    <div class="filter-card">
      <div class="filter-row">
        <div class="filter-item">
          <label class="filter-label">ÂºÇÂ∏∏Áä∂ÊÄÅ</label>
          <ElSelect v-model="filters.exceptionStatus" placeholder="ÂÖ®ÈÉ®" clearable>
            <ElOption
              v-for="item in exceptionStatusOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </div>

        <div class="filter-item">
          <label class="filter-label">ÂºÇÂ∏∏Á±ªÂûã</label>
          <ElSelect v-model="filters.exceptionType" placeholder="ÂÖ®ÈÉ®" clearable>
            <ElOption
              v-for="item in exceptionTypeOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </div>

        <div class="filter-item">
          <label class="filter-label">Á¥ßÊÄ•Á®ãÂ∫¶/‰ºòÂÖàÁ∫ß</label>
          <ElSelect v-model="filters.urgencyLevel" placeholder="ÂÖ®ÈÉ®" clearable>
            <ElOption
              v-for="item in urgencyLevelOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </div>

        <div class="filter-item">
          <label class="filter-label">Â§ÑÁêÜÁä∂ÊÄÅ</label>
          <ElSelect v-model="filters.processingStatus" placeholder="ÂÖ®ÈÉ®" clearable>
            <ElOption
              v-for="item in processingStatusOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </div>

        <div class="filter-item">
          <label class="filter-label">‰∏ªË¥£‰∫∫</label>
          <ElSelect v-model="filters.handler" placeholder="ÂÖ®ÈÉ®" clearable>
            <ElOption label="Âº†‰∏â" value="1" />
            <ElOption label="ÊùéÂõõ" value="2" />
            <ElOption label="Áéã‰∫î" value="3" />
          </ElSelect>
        </div>

        <div class="filter-item">
          <label class="filter-label">Êó∂Èó¥</label>
          <ElDatePicker
            v-model="filters.dateRange"
            type="daterange"
            range-separator="Ëá≥"
            start-placeholder="ÂºÄÂßãÊó•Êúü"
            end-placeholder="ÁªìÊùüÊó•Êúü"
          />
        </div>

        <div class="filter-actions">
          <ElButton type="primary" :icon="Search" @click="handleSearch">ÊêúÁ¥¢</ElButton>
          <ElButton :icon="Refresh" @click="handleReset">ÈáçÁΩÆ</ElButton>
        </div>
      </div>

      <div class="keyword-search">
        <ElInput
          v-model="filters.keyword"
          placeholder="ËØ∑ËæìÂÖ•ÂºÇÂ∏∏ÁºñÂè∑„ÄÅËÆ¢ÂçïÁºñÂè∑Á≠âÂÖ≥ÈîÆËØçÊêúÁ¥¢"
          clearable
          style="width: 400px"
        >
          <template #prefix>
            <ElIcon><Search /></ElIcon>
          </template>
        </ElInput>
      </div>
    </div>

    <!-- Êìç‰ΩúÊ†è -->
    <div class="toolbar">
      <div class="toolbar-left">
        <ElButton type="primary" :icon="Download" @click="handleExport">ÂØºÂá∫</ElButton>
        <ElButton @click="handleBatchProcess">ÊâπÈáèÂ§ÑÁêÜ</ElButton>
      </div>
      <div class="toolbar-right">
        <ElButton text>Âà∑Êñ∞</ElButton>
        <ElButton text>Â∑≤Â§ÑÁêÜÂºÇÂ∏∏</ElButton>
      </div>
    </div>

    <!-- ÂºÇÂ∏∏ËÆ¢ÂçïÂàóË°® -->
    <div class="exception-table-card">
      <ElTable :data="exceptionList" stripe style="width: 100%">
        <ElTableColumn type="selection" width="50" />

        <ElTableColumn label="ÂºÇÂ∏∏ÁºñÂè∑" width="150" fixed>
          <template #default="{ row }">
            <div class="exception-id">{{ row.id }}</div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="ÂÖ≥ËÅîËÆ¢ÂçïÂè∑" width="150">
          <template #default="{ row }">
            <div class="order-no">{{ row.orderNo }}</div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="ÂÖ≥ËÅîËøêÂçï/ÊèêË¥ßÂçï" width="180">
          <template #default="{ row }">
            <div class="related-info">
              <div class="related-item">ËøêÂçïÔºö{{ row.waybillNo }}</div>
              <div class="related-item">ÊèêË¥ßÔºö{{ row.pickupNo }}</div>
            </div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="ÂºÇÂ∏∏Á±ªÂûã" width="120">
          <template #default="{ row }">
            <ElTag :type="row.exceptionTypeTag" size="small">{{ row.exceptionType }}</ElTag>
          </template>
        </ElTableColumn>

        <ElTableColumn label="ÂºÇÂ∏∏Áä∂ÊÄÅ" width="100">
          <template #default="{ row }">
            <ElTag :type="row.statusType" size="small">{{ row.status }}</ElTag>
          </template>
        </ElTableColumn>

        <ElTableColumn label="‰ºòÂÖàÁ∫ß" width="100">
          <template #default="{ row }">
            <ElTag :type="row.urgencyType" size="small">{{ row.urgency }}</ElTag>
          </template>
        </ElTableColumn>

        <ElTableColumn label="‰∏äÊä•‰∫∫/Êó∂Èó¥" width="180">
          <template #default="{ row }">
            <div class="reporter-info">
              <div class="reporter-name">{{ row.reporter }}</div>
              <div class="reporter-time">{{ row.reportTime }}</div>
            </div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="Â§ÑÁêÜ‰∫∫/Êó∂Èó¥" width="180">
          <template #default="{ row }">
            <div class="handler-info">
              <div class="handler-name">{{ row.handler }}</div>
              <div class="handler-time">{{ row.processingTime }}</div>
            </div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="ÂºÇÂ∏∏ÊèèËø∞" width="250">
          <template #default="{ row }">
            <div class="description">{{ row.description }}</div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="Â§ÑÁêÜÊñπÊ°à" width="250">
          <template #default="{ row }">
            <div class="solution">{{ row.solution || '-' }}</div>
          </template>
        </ElTableColumn>

        <ElTableColumn label="Êìç‰Ωú" width="150" fixed="right">
          <template #default="{ row }">
            <ElButton link type="primary" size="small" @click="handleView(row)"> ËØ¶ÊÉÖ </ElButton>
            <ElButton
              v-if="row.status === 'ÂæÖÂ§ÑÁêÜ'"
              link
              type="primary"
              size="small"
              @click="handleProcess(row)"
            >
              Â§ÑÁêÜ
            </ElButton>
            <ElButton v-if="row.status === 'Â∑≤Â§ÑÁêÜ'" link type="success" size="small">
              Êü•Áúã
            </ElButton>
          </template>
        </ElTableColumn>
      </ElTable>

      <!-- ÂàÜÈ°µ -->
      <div class="pagination-wrapper">
        <ElPagination
          v-model:current-page="pagination.currentPage"
          v-model:page-size="pagination.pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :total="pagination.total"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handlePageChange"
        />
      </div>
    </div>
  </div>
</template>

<style scoped>
.exception-container {
  padding: 0;
  background: #f8f9fa;
}

/* ÁªüËÆ°Âç°Áâá */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 16px;
}

.stat-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  border: 1px solid #f0f0f0;
  transition: all 0.3s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  font-size: 32px;
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
}

.stat-content {
  flex: 1;
}

.stat-label {
  font-size: 13px;
  color: #8c8c8c;
  margin-bottom: 6px;
}

.stat-value {
  font-size: 28px;
  font-weight: 600;
  color: #262626;
  margin-bottom: 4px;
}

.stat-change {
  font-size: 12px;
  color: #52c41a;
}

/* Á≠õÈÄâÂå∫Âüü */
.filter-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  border: 1px solid #f0f0f0;
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
  margin-bottom: 16px;
}

.filter-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-label {
  font-size: 13px;
  color: #595959;
  font-weight: 500;
}

.filter-item :deep(.el-select) {
  width: 160px;
}

.filter-actions {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

.keyword-search {
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
}

/* Êìç‰ΩúÊ†è */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.toolbar-left,
.toolbar-right {
  display: flex;
  gap: 8px;
}

/* ÂºÇÂ∏∏ËÆ¢ÂçïË°®Ê†º */
.exception-table-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  border: 1px solid #f0f0f0;
}

.exception-id {
  font-size: 13px;
  font-weight: 600;
  color: #1890ff;
  cursor: pointer;
}

.exception-id:hover {
  text-decoration: underline;
}

.order-no {
  font-size: 13px;
  color: #262626;
}

.related-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.related-item {
  font-size: 12px;
  color: #595959;
}

.reporter-info,
.handler-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.reporter-name,
.handler-name {
  font-size: 12px;
  color: #262626;
  font-weight: 500;
}

.reporter-time,
.handler-time {
  font-size: 11px;
  color: #8c8c8c;
}

.description,
.solution {
  font-size: 12px;
  color: #595959;
  line-height: 1.5;
}

/* ÂàÜÈ°µ */
.pagination-wrapper {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
}

:deep(.el-table) {
  font-size: 13px;
}

:deep(.el-table th) {
  background: #fafafa;
  color: #595959;
  font-weight: 600;
}

:deep(.el-table td) {
  padding: 12px 0;
}
</style>
